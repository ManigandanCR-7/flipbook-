<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Elegant Flipbook Viewer</title>
<style>
  :root {
    --bg: #111; /* Matte black */
    --fg: #fff;
    --book-width: 900px;   /* reduced width */
    --book-height: 540px;  /* reduced height */
    --page-width: calc(var(--book-width) / 2);
    --page-height: var(--book-height);
  }
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    overflow: hidden; /* no scrollbars */
    background: var(--bg);
    color: var(--fg);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    display: flex;
    flex-direction: column;
  }
  header {
    flex-shrink: 0;
    width: 100%;
    max-width: var(--book-width);
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    box-sizing: border-box;
  }
  h1 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
  }
  input[type=file] {
    padding: 6px;
  }
  .flipbook-container {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 50px 0; /* top/bottom gap */
    box-sizing: border-box;
  }
  #flipbook {
    width: var(--book-width);
    height: var(--book-height);
  }
  .page {
    width: var(--page-width);
    height: var(--page-height);
    background: white;
    box-shadow: 0 6px 30px rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
  }
  .page img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
</style>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/blasten/turn.js/turn.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
</head>
<body>
<header>
  <h1>Flipbook Viewer</h1>
  <input id="file-input" type="file" accept="application/pdf" />
</header>

<div class="flipbook-container">
  <div id="flipbook"></div>
</div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

document.getElementById('file-input').addEventListener('change', async e => {
  const file = e.target.files[0];
  if (!file || file.type !== 'application/pdf') {
    alert('Please select a PDF.');
    return;
  }

  // Reset flipbook
  if ($("#flipbook").data("turn")) {
    $('#flipbook').turn('destroy').empty();
  } else {
    $('#flipbook').empty();
  }

  const pdf = await pdfjsLib.getDocument({ data: await file.arrayBuffer() }).promise;

  const pagePromises = [];
  for (let n = 1; n <= pdf.numPages; n++) {
    pagePromises.push(renderPage(pdf, n));
  }

  // Wait for ALL pages to be ready
  const pagesHTML = await Promise.all(pagePromises);

  // Add them to DOM
  $('#flipbook').html(pagesHTML.join(''));

  // Now init Turn.js AFTER all pages are rendered
  $('#flipbook').turn({
    width: parseInt(getComputedStyle(document.documentElement).getPropertyValue('--book-width')),
    height: parseInt(getComputedStyle(document.documentElement).getPropertyValue('--book-height')),
    autoCenter: true,
    display: 'double',
    duration: 1500,
    elevation: 50,
    gradients: true
  });

  // Keyboard controls
  document.addEventListener('keydown', e => {
    if (e.key === 'ArrowRight') $('#flipbook').turn('next');
    if (e.key === 'ArrowLeft') $('#flipbook').turn('previous');
  });

  // Click to turn
  $('#flipbook').on('click', function(e) {
    const offset = $(this).offset();
    const center = offset.left + $(this).width() / 2;
    if (e.pageX > center) {
      $('#flipbook').turn('next');
    } else {
      $('#flipbook').turn('previous');
    }
  });
});

async function renderPage(pdf, pageNum) {
  const page = await pdf.getPage(pageNum);
  const desiredWidth = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--page-width'));
  const viewport = page.getViewport({ scale: 1 });
  const scale = desiredWidth / viewport.width;
  const scaledViewport = page.getViewport({ scale });

  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = scaledViewport.width;
  canvas.height = scaledViewport.height;

  await page.render({ canvasContext: ctx, viewport: scaledViewport }).promise;

  return `<div class="page"><img src="${canvas.toDataURL('image/png')}" alt="Page ${pageNum}"></div>`;
}
</script>
</body>
</html>
